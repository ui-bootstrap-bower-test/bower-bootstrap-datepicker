angular.module("ui.bootstrap.datepicker",["ui.bootstrap.position"]).constant("datepickerConfig",{dayFormat:"dd",monthFormat:"MMMM",yearFormat:"yyyy",dayHeaderFormat:"EEE",dayTitleFormat:"MMMM yyyy",monthTitleFormat:"yyyy",showWeeks:!0,startingDay:0,yearRange:20,minDate:null,maxDate:null}).controller("DatepickerController",["$scope","$attrs","dateFilter","datepickerConfig",function(e,t,a,n){function r(t,a){return angular.isDefined(t)?e.$parent.$eval(t):a}function i(e,t){return new Date(e,t,0).getDate()}function o(e,t){for(var a=new Array(t),n=e,r=0;t>r;)a[r++]=new Date(n),n.setDate(n.getDate()+1);return a}function l(e,t,n,r){return{date:e,label:a(e,t),selected:!!n,secondary:!!r}}var s={day:r(t.dayFormat,n.dayFormat),month:r(t.monthFormat,n.monthFormat),year:r(t.yearFormat,n.yearFormat),dayHeader:r(t.dayHeaderFormat,n.dayHeaderFormat),dayTitle:r(t.dayTitleFormat,n.dayTitleFormat),monthTitle:r(t.monthTitleFormat,n.monthTitleFormat)},u=r(t.startingDay,n.startingDay),d=r(t.yearRange,n.yearRange);this.minDate=n.minDate?new Date(n.minDate):null,this.maxDate=n.maxDate?new Date(n.maxDate):null,this.modes=[{name:"day",getVisibleDates:function(e,t){var n=e.getFullYear(),r=e.getMonth(),d=new Date(n,r,1),c=u-d.getDay(),p=c>0?7-c:-c,g=new Date(d),m=0;p>0&&(g.setDate(-p+1),m+=p),m+=i(n,r+1),m+=(7-m%7)%7;for(var f=o(g,m),D=new Array(7),h=0;m>h;h++){var y=f[h];f[h]=l(y,s.day,t&&t.getDate()===y.getDate()&&t.getMonth()===y.getMonth()&&t.getFullYear()===y.getFullYear(),y.getMonth()!==r)}for(var w=0;7>w;w++)D[w]=a(f[w].date,s.dayHeader);return{objects:f,title:a(e,s.dayTitle),labels:D}},compare:function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate())-new Date(t.getFullYear(),t.getMonth(),t.getDate())},split:7,step:{months:1}},{name:"month",getVisibleDates:function(e,t){for(var n=new Array(12),r=e.getFullYear(),i=0;12>i;i++){var o=new Date(r,i,1);n[i]=l(o,s.month,t&&t.getMonth()===i&&t.getFullYear()===r)}return{objects:n,title:a(e,s.monthTitle)}},compare:function(e,t){return new Date(e.getFullYear(),e.getMonth())-new Date(t.getFullYear(),t.getMonth())},split:3,step:{years:1}},{name:"year",getVisibleDates:function(e,t){for(var a=new Array(d),n=e.getFullYear(),r=parseInt((n-1)/d,10)*d+1,i=0;d>i;i++){var o=new Date(r+i,0,1);a[i]=l(o,s.year,t&&t.getFullYear()===o.getFullYear())}return{objects:a,title:[a[0].label,a[d-1].label].join(" - ")}},compare:function(e,t){return e.getFullYear()-t.getFullYear()},split:5,step:{years:d}}],this.isDisabled=function(t,a){var n=this.modes[a||0];return this.minDate&&n.compare(t,this.minDate)<0||this.maxDate&&n.compare(t,this.maxDate)>0||e.dateDisabled&&e.dateDisabled({date:t,mode:n.name})}}]).directive("datepicker",["dateFilter","$parse","datepickerConfig","$log",function(e,t,a,n){return{restrict:"EA",replace:!0,templateUrl:"template/datepicker/datepicker.html",scope:{dateDisabled:"&"},require:["datepicker","?^ngModel"],controller:"DatepickerController",link:function(e,r,i,o){function l(){e.showWeekNumbers=0===m&&D}function s(e,t){for(var a=[];e.length>0;)a.push(e.splice(0,t));return a}function u(t){var a=null,r=!0;g.$modelValue&&(a=new Date(g.$modelValue),isNaN(a)?(r=!1,n.error('Datepicker directive: "ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.')):t&&(f=a)),g.$setValidity("date",r);var i=p.modes[m],o=i.getVisibleDates(f,a);angular.forEach(o.objects,function(e){e.disabled=p.isDisabled(e.date,m)}),g.$setValidity("date-disabled",!a||!p.isDisabled(a)),e.rows=s(o.objects,i.split),e.labels=o.labels||[],e.title=o.title}function d(e){m=e,l(),u()}function c(e){var t=new Date(e);t.setDate(t.getDate()+4-(t.getDay()||7));var a=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((a-t)/864e5)/7)+1}var p=o[0],g=o[1];if(g){var m=0,f=new Date,D=a.showWeeks;i.showWeeks?e.$parent.$watch(t(i.showWeeks),function(e){D=!!e,l()}):l(),i.min&&e.$parent.$watch(t(i.min),function(e){p.minDate=e?new Date(e):null,u()}),i.max&&e.$parent.$watch(t(i.max),function(e){p.maxDate=e?new Date(e):null,u()}),g.$render=function(){u(!0)},e.select=function(e){if(0===m){var t=g.$modelValue?new Date(g.$modelValue):new Date(0,0,0,0,0,0,0);t.setFullYear(e.getFullYear(),e.getMonth(),e.getDate()),g.$setViewValue(t),u(!0)}else f=e,d(m-1)},e.move=function(e){var t=p.modes[m].step;f.setMonth(f.getMonth()+e*(t.months||0)),f.setFullYear(f.getFullYear()+e*(t.years||0)),u()},e.toggleMode=function(){d((m+1)%p.modes.length)},e.getWeekNumber=function(t){return 0===m&&e.showWeekNumbers&&7===t.length?c(t[0].date):null}}}}}]).constant("datepickerPopupConfig",{dateFormat:"yyyy-MM-dd",currentText:"Today",toggleWeeksText:"Weeks",clearText:"Clear",closeText:"Done",closeOnDateSelection:!0,appendToBody:!1,showButtonBar:!0}).directive("datepickerPopup",["$compile","$parse","$document","$position","dateFilter","datepickerPopupConfig","datepickerConfig",function(e,t,a,n,r,i,o){return{restrict:"EA",require:"ngModel",link:function(l,s,u,d){function c(e){$?$(l,!!e):D.isOpen=!!e}function p(e){if(e){if(angular.isDate(e))return d.$setValidity("date",!0),e;if(angular.isString(e)){var t=new Date(e);return isNaN(t)?void d.$setValidity("date",!1):(d.$setValidity("date",!0),t)}return void d.$setValidity("date",!1)}return d.$setValidity("date",!0),null}function g(e,a,n){e&&(l.$watch(t(e),function(e){D[a]=e}),F.attr(n||a,a))}function m(){D.position=y?n.offset(s):n.position(s),D.position.top=D.position.top+s.prop("offsetHeight")}var f,D=l.$new(),h=angular.isDefined(u.closeOnDateSelection)?l.$eval(u.closeOnDateSelection):i.closeOnDateSelection,y=angular.isDefined(u.datepickerAppendToBody)?l.$eval(u.datepickerAppendToBody):i.appendToBody;u.$observe("datepickerPopup",function(e){f=e||i.dateFormat,d.$render()}),D.showButtonBar=angular.isDefined(u.showButtonBar)?l.$eval(u.showButtonBar):i.showButtonBar,l.$on("$destroy",function(){V.remove(),D.$destroy()}),u.$observe("currentText",function(e){D.currentText=angular.isDefined(e)?e:i.currentText}),u.$observe("toggleWeeksText",function(e){D.toggleWeeksText=angular.isDefined(e)?e:i.toggleWeeksText}),u.$observe("clearText",function(e){D.clearText=angular.isDefined(e)?e:i.clearText}),u.$observe("closeText",function(e){D.closeText=angular.isDefined(e)?e:i.closeText});var w,$;u.isOpen&&(w=t(u.isOpen),$=w.assign,l.$watch(w,function(e){D.isOpen=!!e})),D.isOpen=w?w(l):!1;var v=function(e){D.isOpen&&e.target!==s[0]&&D.$apply(function(){c(!1)})},k=function(){D.$apply(function(){c(!0)})},b=angular.element("<div datepicker-popup-wrap><div datepicker></div></div>");b.attr({"ng-model":"date","ng-change":"dateSelection()"});var F=angular.element(b.children()[0]),T={};u.datepickerOptions&&(T=l.$eval(u.datepickerOptions),F.attr(angular.extend({},T))),d.$parsers.unshift(p),D.dateSelection=function(e){angular.isDefined(e)&&(D.date=e),d.$setViewValue(D.date),d.$render(),h&&c(!1)},s.bind("input change keyup",function(){D.$apply(function(){D.date=d.$modelValue})}),d.$render=function(){var e=d.$viewValue?r(d.$viewValue,f):"";s.val(e),D.date=d.$modelValue},g(u.min,"min"),g(u.max,"max"),u.showWeeks?g(u.showWeeks,"showWeeks","show-weeks"):(D.showWeeks="show-weeks"in T?T["show-weeks"]:o.showWeeks,F.attr("show-weeks","showWeeks")),u.dateDisabled&&F.attr("date-disabled",u.dateDisabled);var x=!1,M=!1;D.$watch("isOpen",function(e){e?(m(),a.bind("click",v),M&&s.unbind("focus",k),s[0].focus(),x=!0):(x&&a.unbind("click",v),s.bind("focus",k),M=!0),$&&$(l,e)}),D.today=function(){D.dateSelection(new Date)},D.clear=function(){D.dateSelection(null)};var V=e(b)(D);y?a.find("body").append(V):s.after(V)}}}]).directive("datepickerPopupWrap",function(){return{restrict:"EA",replace:!0,transclude:!0,templateUrl:"template/datepicker/popup.html",link:function(e,t){t.bind("click",function(e){e.preventDefault(),e.stopPropagation()})}}});